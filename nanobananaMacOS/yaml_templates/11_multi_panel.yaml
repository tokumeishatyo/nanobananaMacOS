{{> header header_comment="Multi Panel Manga (漫画作成)"}}

# ====================================================
# Main Prompt and Layout (メインプロンプトとレイアウト)
# ====================================================
main_prompt:
  - "Generate a {{panel_count}}-panel manga as a single vertical image based strictly on the YAML instructions below."
  - "CRITICAL: Use the attached reference images (face and costume sheets) to maintain perfect character consistency across all panels."

layout_instruction:
  - "Layout format: Vertical strip, 1 column, {{panel_count}} rows."
  - "Order: Panel 1 at the top, Panel {{panel_count}} at the bottom."
  - "Aspect Ratio: Vertical. The {{panel_count}} panels must occupy the entire image area."
  - "Margins: Minimal white space. No wide borders."
  - "Character Consistency: Strictly adhere to the attached reference sheets for facial features and clothing."
  - "Art Style: Flat color, anime style, clean line art (as defined in constraints)."
  - "Dialogue: Render text clearly inside speech bubbles. Place bubbles strategically to not cover faces."
  - "Narration: Place narration text in rectangular boxes at the top or bottom of the panel edges."
  - "Follow the positioning_rule and narration_rule in each panel."

# ====================================================
# Panel Count (コマ数)
# ====================================================
panel_count: {{panel_count}}

{{component_registry}}
# ====================================================
# Panels (各コマの内容)
# ====================================================
{{panels_content}}

# ====================================================
# Assembly Logic (AIへの合成指示)
# ====================================================
# face_reference画像とappearance_compilationの情報を組み合わせてキャラクターを描画
instructions:
  - "Use 'face_reference' image as the primary visual reference for the character's face."
  - "Use 'appearance_compilation' fields to render the character's full appearance:"
  - "  - Face: Use facial feature description to ensure consistency with face_reference image."
  - "  - Body: Apply body type description when rendering the character's physique."
  - "  - Outfit: Render clothing exactly as described in this field."
  - "The 'features' field specifies ONLY acting, pose, and expression - NOT appearance."
  - "Apply the pose/expression from 'features' while maintaining appearance from 'appearance_compilation'."
  - "Ensure consistent art style and character identity across all panels."

# ====================================================
# Constraints (CRITICAL)
# ====================================================
constraints:
  character_rendering:
    - "Preserve exact character appearance from input images"
    - "Apply the specified features (expression, pose) to each character"
    - "Maintain character identity across all panels"
  character_positioning:
    - "Follow the 'position' field for each character strictly"
    - "Absolute positions: 'on the left side', 'center', 'on the right side'"
    - "Relative positions: 'to the immediate right of [name]'"
    - "Scene description reinforces positioning - follow it"
  person_count:
    - "The 'tags' field specifies exact person count"
    - "'solo' = exactly 1 person, no extras"
    - "'duo' = exactly 2 people, no extras"
    - "'trio' = exactly 3 people, no extras"
    - "'crowd' = main characters + background people"
    - "'crowd' with 'depth of field' = background people are blurred"
    - "'crowd' with 'sharp focus' = background people are clearly drawn"
  panel_layout:
    - "Arrange panels vertically from top to bottom"
    - "Each panel should have clear boundaries"
  dialogue_rules:
    - "Display dialogue in speech bubbles near the speaking character"
    - "Position dialogue appropriately within the panel"
  narration_rules:
    - "Follow the 'narration_rule' field in each panel for narration placement"
    - "Each panel specifies its own narration position and text orientation"
  transparency_handling:
    - "Recognize checkerboard patterns in character images as TRANSPARENT backgrounds"
    - "Remove/ignore the transparent background area so only the character is visible"
  # 【必須】吹き出し制御ルール (Bubble Control Rules)
  bubble_rendering:
    # 1. 辞書の参照ルール
    - "Reference 'bubble_registry' to determine the shape of speech bubbles (e.g., 'scream', 'shout')."
    # 2. キャラクターのセリフ用 (Pattern A)
    - "If a character has a 'bubble_style' field, render their speech bubble in that specific shape."
    - "If 'bubble_style' is specified (e.g., 'scream'), STRICTLY follow that shape."
    - "If 'bubble_style' is 'auto' or missing, analyze the dialogue text emotion and choose the most appropriate shape automatically."
    # 3. シーン内の特殊効果用 (Pattern B)
    - "Recognize syntax '[Visual Effect: STYLE | FACE_SOURCE | TEXT]' in scene descriptions."
    - "For this syntax, render a FLOATING bubble of the specified 'STYLE'."
    - "Inside the floating bubble, show ONLY the 'FACE_SOURCE' face and the 'TEXT'."
    - "CRITICAL: Do NOT render the body of the 'FACE_SOURCE' actor for floating bubbles."

# ====================================================
# Anti-Hallucination (MUST FOLLOW)
# ====================================================
anti_hallucination:
  - "Do NOT alter character designs from input images"
  - "Do NOT add characters not specified in the panel (unless 'crowd' tag is present)"
  - "Do NOT change dialogue text"
  - "Do NOT change narration text"
  - "Do NOT swap character positions - follow 'position' field exactly"
  - "Do NOT ignore 'tags' field - it controls person count"
  - "Do NOT ignore 'narration_position' field - it controls narration placement"
  - "Do NOT use horizontal text when 'narration_orientation' is 'vertical'"

# ====================================================
# Output Cleanliness (CRITICAL)
# ====================================================
output_cleanliness:
  - "Output ONLY the manga panels - nothing else"
  - "Do NOT add watermarks, signatures, or logos"
  - "Do NOT add extra decorative elements outside panels"
